<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tiledesk-email-transcript-app</title>
    <link rel="stylesheet" href="./css/base.css">
  <script>
  
    window.addEventListener("message", (event) => {
    console.log('addEventListener_frame: ', event)
    if(event && event.data){
      //GET TOK  EN FROM PAGE TILEDESK
      const token = document.getElementById("token");
      console.log('token: ',token)
      token.value = event.data.token;
      console.log('token.value: ',token.value)
      var projectId = document.getElementById("projectId");
      if(event.data.request.id_project){
        projectId.value = event.data.request.id_project;
        // ESEMPIO PER LEGGERE LA MAIL DELL'UTENTE
        console.log('projectId: ',projectId.value)
      }
      var requestId = document.getElementById("request_id");
      requestId.value = event.data.request.request_id;
      console.log('RequestId: ',requestId.value)
      const cnf_send = document.getElementById("cnf_send");
      // CALL THE SERVICE FOR EMAIL TRANSCRIPTION
      readTrascriptionChat();
  }
}, false);


  </script>  
</head>

<body>
  <script src="https://replit.com/public/js/replit-badge.js" theme="blue" defer></script>
  <div id="form" class="container" style="display:flex; align-items: center; justify-content: center;">
   <div id="createdMail">
   <p class="subtitle" id="app_name" style="text-align:center; margin-bottom: 22px;">Send transcript by email</p>
     <div class="form-group">
     <label class="input-label" for="recipient_address">Email addresses</label>
     <div style="display: flex; flex-direction: row;">
        <div>
         <div style="display: flex; flex-direction: row; align-items: center;">
          <input type="email" class="form-control copy-form custom-input" name="recipient_address" id="recipient_address" oninput="reWrite()" placeholder="Insert the email addresses.. " required/>
         </div>
        </div>
      </div>
     </div>

     <div class="form-group">
     <label class="input-label" for="object">Subject of the email</label>
     <div style="display: flex; flex-direction: row;">
        <div>
          <div style="display: flex; flex-direction: row; align-items: center;">
          <input type="text" class="form-control copy-form custom-input" name="object" id="object" placeholder="Insert the subject of the email.."/>
          </div>
        </div>
      </div>
     </div>
     <div>
       <div class="form-group">
        <label class="input-label" for="message">Chat text</label>
     <div style="display: flex; flex-direction: row;">
        <div >
          <div style="display: flex; flex-direction: row; align-items: center;">
            <textarea id="message"  class="form-control copy-form custom-input areatext" name="message" rows="8" cols="33" required placeholder="Insert the transcript of the chat.."></textarea>
          </div>
        </div>
      </div> 
       </div>

       
     
      <!-- SEND TOKEN TO INDEX.JS -->
      <input type='hidden' id='token' name='token' />
      <input type='hidden' id='projectId' name='projectId' />
      <input type='hidden' id='request_id' name='request_id' />
      <!-- SEND BUTTON -->
      <div style="text-align: center;">
        <button id='send_btn' class="action-button" >Send chat</button>
     </div>
     </div>
     </div>
  </div>
  </div>
   <div id="summaryMail" style='display: none'>
     <p class="info-box" id="app_send" style="text-align:center; margin-bottom: 50px; margin-top: 80px;font-size: 28px"></p>
   </div>
  
 <script>
   // DEFINE THE OBJECT MSG
   var msg = [];
   var message;
   
    function readTrascriptionChat() {
      const requestId = document.getElementById('request_id');
      console.log('rTChat requestID: ', requestId.value);
      // CALL THE SERVICE FOR THE MAIL TRANSCRIPTION (PRODUCTION SYSTEM)
      call_url = 'https://api.tiledesk.com/v2/public/requests/'+ requestId.value +'/messages';
       sendData( {
          request_id:requestId.value,
        }, call_url, 'GET');
    }
   
    function sendData( data, url, opr ) {
      const XHR = new XMLHttpRequest();
      let urlEncodedData = "",
          urlEncodedDataPairs = [],
          name;
      for( name in data ) {
        urlEncodedDataPairs.push( encodeURIComponent( name ) + '=' + encodeURIComponent( data[name] ) );
      }
      urlEncodedData = urlEncodedDataPairs.join( '&' ).replace( /%20/g, '+' );
      XHR.addEventListener("loadend", function(event) {
        console.log('response server mail0: ', XHR.responseText);
        console.log('OPR:',opr);
        let result;
        result = opr.localeCompare('POST');
        console.log('result POST: ',result);
        // SEND MAIL
        if (result == 0) {
          let msgToUser = document.getElementById('app_send');
          let createdMail = document.getElementById('createdMail');
          let summaryMail = document.getElementById('summaryMail');
          console.log ('whatIsIt', XHR.responseText.localeCompare("{queued:true}"));
        if (XHR.responseText.localeCompare("{queued:true}") == -1) {
          var resp_mail = JSON.parse(XHR.responseText);
          console.log('response server mail1: ', resp_mail);
          console.log('response server mail JSON1: ', resp_mail.queued);
          //Check that the email has been sent correctly
          if (resp_mail.queued) {
            createdMail.style.display = "none";
            msgToUser.innerHTML = "Email sent successfully!"
            summaryMail.style.display = "block";
            document.getElementById("recipient_address").value = "";
            document.getElementById("object").value = "";
            document.getElementById("message").value = "";
          } 
        } else {
          createdMail.style.display = "none";
          summaryMail.style.display = "block";
          console.log('response server mail2: ', resp_mail);
          msgToUser.innerHTML = "The following error has occurred! "+"'"+resp_mail+"''";
        }
      }
        result = opr.localeCompare('GET');
        console.log('result GET: ',result);
        message = document.getElementById('message');
        // READ TRANSCRIPTION
         if (result == 0) {
           message.innerHTML = '';
           var jsonData = JSON.parse(XHR.responseText);
           console.log('response transcript mail JSON: ', jsonData);
           // INSERT MSG JSON INTO ARRAY MSG
           for (var i = 0; i < jsonData.length; i++) {
            var singlemsg = jsonData[i];
             console.log('user',singlemsg.senderFullname);
             console.log('text',singlemsg.text);
             msg.push(singlemsg);
            // populate the text area
           message.innerHTML += singlemsg.senderFullname;
           message.innerHTML += ": ";
           message.innerHTML += singlemsg.text;
          if (i < jsonData.length -1) {
              message.innerHTML += "\n\n";
          }
          }    
         } 
        
      });
      XHR.addEventListener( 'error', function(event) {
        console.log( 'Oops! Something went wrong.' );
      } );
      //XHR.open( 'POST', '/payment/created' );
      console.log( 'Send mail url/', url ); 
      console.log( 'Send mail data/', data ); 
      console.log( 'Send mail token/', token.value);
      XHR.open( opr, url );
      XHR.setRequestHeader( 'Content-Type', 'application/x-www-form-urlencoded' );
      //XHR.setRequestHeader("Authorization", "Basic " + btoa("user:pass"));
      XHR.setRequestHeader("Authorization", token.value);
      XHR.send( urlEncodedData );
      // Capture the response to the server mail
      XHR.onreadystatechange = function() {
        if (this.status == 200) {
           // Typical action to be performed when the document is ready:
          console.log('Response Call: ', XHR.responseText);
        } else {
          console.log('Response Call: ', XHR.responseText);
        }
      };
    }
    const btnSend = document.getElementById('send_btn');
    const error = document.getElementById('error');
    btnSend.addEventListener( 'click', function() {
      const recipient_address = document.getElementById('recipient_address');
      const object = document.getElementById('object');
      message = document.getElementById('message');
      const projectId = document.getElementById('projectId');
      //------------------------------------------------------------
      // VALIDATE CUSTOMER MAIL
      var mail = false;
      //var mailformat = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;
      var mailformat = /^[^\s;]+@[^\s;]+\.[^\s;]+(?:;[^\s;]+@[^\s;]+\.[^\s;]+)*$/;
      if (recipient_address.value.match(mailformat)) {
        //alert("You have entered a Valid email address!");
        recipient_address.focus();
        mail_correct = true;
        //return true;
      }
      else {
        //alert("Invalid Email Address");
        recipient_address.focus();
        mail_correct = false;
        //return false;
      }
      //------------------------------------------------------------
      console.log("Payment/recipient_address: ", recipient_address.value);
      console.log("Payment/object: ", object.value);
      // ADD TO MSG THE PRESENTATION:
      var mess = message.value;
      console.log("Payment/message 1: ", message.innerHTML);
      message.innerHTML = 'Below is the chat history: ';
      message.innerHTML += '\n\n';
      message.innerHTML += mess;
      message.innerHTML += '\n\n';
      message.innerHTML += 'Best regards! The Tiledesk team.';
      console.log("Payment/message 2: ", message.innerHTML);
      console.log("Payment/token: ", token.value);
      console.log("Payment/Project ID: ", projectId.value);
      console.log("Payment/mail_correct: ", mail_correct);
      if ( mail_correct == true && recipient_address.value != '' && recipient_address.value != 'The email is incorrect!'  )     { 
        var send_url = 'https://api.tiledesk.com/v2/'+ projectId.value +'/emails/send';
      if (object) {
        sendData( {
          //token:token.value,
          //projectId:projectId.value,
          //request_id:request_id.value,
          to:recipient_address.value,
          subject:object.value,
          text:message.innerHTML
        }, send_url, 'POST');
      }  else {
        //amount.value = 0;
      }
      } else {
        recipient_address.value = 'The email is incorrect!';
        recipient_address.style.color='red';
      } 
    });

   // CHANGE COLOR WHILE RE_WRITE THE INPUT TEXT MAIL
    function reWrite() {
      recipient_address = document.getElementById('recipient_address');
      recipient_address.style.color='black';
    }
    // SELECT THE INPUT TEXT MAIL
    function Reselect() {
      recipient_address = document.getElementById('recipient_address');
      recipient_address.value='';
      console.log('CIAO');
    }
   var stringConstructor = "test".constructor;
var arrayConstructor = [].constructor;
var objectConstructor = ({}).constructor;

function whatIsIt(object) {
    if (object === null) {
        return "null";
    }
    if (object === undefined) {
        return "undefined";
    }
    if (object.constructor === stringConstructor) {
        return "String";
    }
    if (object.constructor === arrayConstructor) {
        return "Array";
    }
    if (object.constructor === objectConstructor) {
        return "Object";
    }
    {
        return "don't know";
    }
}

var testSubjects = ["string", [1,2,3], {foo: "bar"}, 4];

for (var i=0, len = testSubjects.length; i < len; i++) {
    //alert(whatIsIt(testSubjects[i]));
}
  </script>
</body>
</html>